<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>éŒ²éŸ³â†’æ–‡å­—èµ·ã“ã—â†’è¦ç´„ãƒ‡ãƒ¢</title>
</head>
<body>
<h1>ğŸ¤ éŒ²éŸ³ã—ã¦æ–‡å­—èµ·ã“ã—ï¼†è¦ç´„</h1>

<button id="startBtn">éŒ²éŸ³é–‹å§‹</button>
<button id="stopBtn" disabled>éŒ²éŸ³åœæ­¢</button>

<p id="status">â±ï¸ éŒ²éŸ³å‰</p>

<audio id="audioPlayer" controls style="display:none; margin-top:10px;"></audio>

<div id="result" style="margin-top:20px;"></div>

<script>
let mediaRecorder;
let stream;
let timerInterval;
let sendInterval;
let chunks = [];
let transcriptionText = "";

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const status = document.getElementById("status");
const audioPlayer = document.getElementById("audioPlayer");
const resultDiv = document.getElementById("result");
const CHUNK_INTERVAL_MS = 60000;// 30ç§’ã”ã¨ã«é€ä¿¡

startBtn.onclick = async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        let mimeType = "";
        let fileExt = "";
        if (MediaRecorder.isTypeSupported("audio/webm")) {
            mimeType = "audio/webm";
            fileExt = "webm";
        } else if (MediaRecorder.isTypeSupported("audio/mp4")) {
            mimeType = "audio/mp4";
            fileExt = "mp4";
        } else if (MediaRecorder.isTypeSupported("audio/wav")) {
            mimeType = "audio/wav";
            fileExt = "wav";
        } else {
            alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŒ²éŸ³ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            return;
        }

         chunks = [];
    transcriptionText = "";
    status.textContent = "â±ï¸ éŒ²éŸ³ä¸­: 0ç§’";
    audioPlayer.style.display = "none";
    resultDiv.innerHTML = "";

    mediaRecorder.ondataavailable = async (e) => {
        if (e.data.size > 0) {
            await sendChunkToServer(e.data);
        }
    };

    mediaRecorder.onstart = () => {
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            status.textContent = `â±ï¸ éŒ²éŸ³ä¸­: ${elapsed}ç§’`;
        }, 1000);

        sendInterval = setInterval(() => {
            if (mediaRecorder.state === "recording") {
                mediaRecorder.requestData(); // ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—
            }
        }, CHUNK_INTERVAL_MS);

        startBtn.disabled = true;
        stopBtn.disabled = false;
    };

        mediaRecorder.onstop = () => {
        clearInterval(timerInterval);
        clearInterval(sendInterval);
        stream.getTracks().forEach((track) => track.stop());

        stopBtn.disabled = true;
        startBtn.disabled = false;

        status.textContent = "âœ… éŒ²éŸ³çµ‚äº†ãƒ»ã¾ã¨ã‚ä¸­...";
        summarizeTranscription();
    };

    mediaRecorder.start();
    };
};

stopBtn.onclick = () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
    }
};

async function sendChunkToServer(blob) {
    const formData = new FormData();
    formData.append("file", blob, "chunk.webm");

    try {
        const res = await fetch("https://voice-summary-app.onrender.com/transcribe", {
            method: "POST",
            body: formData,
        });
        const data = await res.json();
        if (data.transcription) {
            transcriptionText += data.transcription + "\n";
            resultDiv.innerHTML = `<h3>ğŸ“ ç¾åœ¨ã®æ–‡å­—èµ·ã“ã—</h3><pre>${transcriptionText}</pre>`;
        }
    } catch (err) {
        console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", err);
    }
}

async function summarizeTranscription() {
    const res = await fetch("https://voice-summary-app.onrender.com/summarize", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: transcriptionText }),
    });
    const data = await res.json();
    resultDiv.innerHTML += `<h3>âœ¨ è¦ç´„</h3><p>${data.summary}</p>`;
    status.textContent = "âœ… å‡¦ç†å®Œäº†";
}
</script>

</body>
</html>
