<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>éŒ²éŸ³â†’æ–‡å­—èµ·ã“ã—â†’è¦ç´„ãƒ‡ãƒ¢</title>
</head>
<body>
<h1>ğŸ¤ éŒ²éŸ³ã—ã¦æ–‡å­—èµ·ã“ã—ï¼†è¦ç´„</h1>

<button id="startBtn">éŒ²éŸ³é–‹å§‹</button>
<button id="stopBtn" disabled>éŒ²éŸ³åœæ­¢</button>

<p id="status">â±ï¸ éŒ²éŸ³å‰</p>

<audio id="audioPlayer" controls style="display:none; margin-top:10px;"></audio>

<div id="result" style="margin-top:20px;"></div>

<script>
let mediaRecorder;
let chunks = [];
let startTime;
let timerInterval;
let stream; // â† streamã‚’å¤–ã«å‡ºã™

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const status = document.getElementById("status");
const audioPlayer = document.getElementById("audioPlayer");
const resultDiv = document.getElementById("result");

startBtn.onclick = async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        // å†ç”Ÿæˆ
        chunks = [];

        let mimeType = "";
        let fileExt = "";
        if (MediaRecorder.isTypeSupported("audio/webm")) {
            mimeType = "audio/webm";
            fileExt = "webm";
        } else if (MediaRecorder.isTypeSupported("audio/wav")) {
            mimeType = "audio/wav";
            fileExt = "wav";
        } else if (MediaRecorder.isTypeSupported("audio/mp4")) {
            mimeType = "audio/mp4";
            fileExt = "mp4";
        } else {
            alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŒ²éŸ³ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚");
            return;
        }

        mediaRecorder = new MediaRecorder(stream, { mimeType });
        let stopResolve;
        const stopped = new Promise(resolve => (stopResolve = resolve));

        mediaRecorder.onstart = () => {
            startTime = Date.now();
            status.textContent = "â±ï¸ éŒ²éŸ³ä¸­: 0ç§’";
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                status.textContent = `â±ï¸ éŒ²éŸ³ä¸­: ${elapsed}ç§’`;
            }, 1000);
            startBtn.disabled = true;
            stopBtn.disabled = false;
            resultDiv.innerHTML = "";
            audioPlayer.style.display = "none";
            audioPlayer.src = "";
        };

        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) chunks.push(e.data);
        };
        

        mediaRecorder.onstop = async () => {
            clearInterval(timerInterval);

            // ãƒ‡ãƒ¼ã‚¿ãŒæƒã†ã¾ã§å°‘ã—å¾…ã¤ï¼ˆrequestDataã§æœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ï¼‰
            await new Promise(r => setTimeout(r, 300)); // å°‘ã—ã ã‘å¾…æ©Ÿï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰

            const blob = new Blob(chunks, { type: mimeType });
            const filename = `recording.${fileExt}`;
            audioPlayer.src = URL.createObjectURL(blob);
            audioPlayer.style.display = "block";

            const formData = new FormData();
            formData.append("file", blob, filename);

            status.textContent = "âŒ› æ–‡å­—èµ·ã“ã—ï¼†è¦ç´„ä¸­...ãŠå¾…ã¡ãã ã•ã„ã€‚";

            try {
                const response = await fetch("https://voice-summary-app.onrender.com/transcribe", {
                    method: "POST",
                    body: formData
                });
                if (!response.ok) throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼");
                const data = await response.json();

                status.textContent = "âœ… å‡¦ç†å®Œäº†";
                resultDiv.innerHTML =
                    `<h3>ğŸ“ æ–‡å­—èµ·ã“ã—çµæœ</h3><p>${data.transcription}</p>` +
                    `<h3>âœ¨ è¦ç´„</h3><p>${data.summary}</p>`;
            } catch (error) {
                status.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
                resultDiv.textContent = error.message;
            }

            stopResolve();
        };

        mediaRecorder.start();
    } catch (err) {
        alert("ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„ã‹ã€éŒ²éŸ³æ©Ÿèƒ½ãŒã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚");
        console.error(err);
    }
};

stopBtn.onclick =async ()=> {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.requestData(); // æœ€å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦æ±‚
        mediaRecorder.stop();
    }
};
</script>

</body>
</html>
