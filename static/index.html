<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>音声文字起こし・要約アプリ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin: 10px 5px; padding: 10px 20px; font-size: 16px; }
    #status { margin-top: 10px; }
    #result { margin-top: 20px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>🎙️ 音声文字起こし & 要約</h1>
  <button id="startBtn">🔴 録音開始</button>
  <button id="stopBtn" disabled>⏹️ 録音停止</button>
  <div id="status">⏳ 準備中...</div>
  <div id="result"></div>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("status");
    const resultDiv = document.getElementById("result");

    let mediaRecorder;
    let transcripts = [];
    let stream;
    let chunkPromises = [];
    let timerInterval;
    let isStopping = false;

    let mimeType = "audio/webm";
    let fileExt = "webm";

    if (MediaRecorder.isTypeSupported("audio/webm")) {
      mimeType = "audio/webm";
      fileExt = "webm";
    } else if (MediaRecorder.isTypeSupported("audio/mp4")) {
      mimeType = "audio/mp4";
      fileExt = "mp4";
    } else {
      alert("このブラウザは音声録音に対応していません。");
    }

    async function transcribeBlob(blob, filename) {
      const formData = new FormData();
      formData.append("file", blob, filename);
      try {
        const response = await fetch("https://voice-summary-app.onrender.com/transcribe", {
          method: "POST",
          body: formData,
        });
        if (!response.ok) throw new Error("サーバーエラー");
        const data = await response.json();
        transcripts.push(data.transcription || "(空の文字起こし)");
      } catch (err) {
        console.error("文字起こしエラー:", err);
        transcripts.push("(文字起こし失敗)");
      }
    }

    startBtn.onclick = async () => {
      transcripts = [];
      chunkPromises = [];
      resultDiv.innerHTML = "";
      status.textContent = "🎙️ 録音中...";
      isStopping = false;

      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType });

      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 1000) {
          const blob = new Blob([e.data], { type: mimeType });
          const filename = `${Date.now()}.${fileExt}`;
          const promise = transcribeBlob(blob, filename);
          chunkPromises.push(promise);
        } else {
          console.log("無効なチャンクをスキップしました size:", e.data.size);
        }
      };

      mediaRecorder.onstop = async () => {
        clearInterval(timerInterval);
        status.textContent = "⌛ 最終データ処理中...";

        try {
          await Promise.all(chunkPromises);
          const fullText = transcripts.join("\n").trim();
          if (!fullText) {
            status.textContent = "⚠️ 文字起こしが空でした。";
            return;
          }

          status.textContent = "⌛ 要約中...";
          const response = await fetch("https://voice-summary-app.onrender.com/summarize", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: fullText }),
          });
          const data = await response.json();

          resultDiv.innerHTML = `
            <h3>📝 全体文字起こし</h3><p>${fullText.replace(/\n/g, "<br>")}</p>
            <h3>✨ 要約</h3><p>${data.summary}</p>
            <button id="downloadBtn" style="margin-top:10px;">📄 PDFをダウンロード</button>
          `;
          status.textContent = "✅ 完了";

          document.getElementById("downloadBtn").onclick = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const content = `【全体文字起こし】\n${fullText}\n\n【要約】\n${data.summary}`;
            const lines = doc.splitTextToSize(content, 180);
            doc.text(lines, 10, 10);
            doc.save("transcription.pdf");
          };
        } catch (err) {
          console.error("要約エラー:", err);
          resultDiv.innerHTML = "<p style='color:red;'>要約エラーが発生しました。</p>";
          status.textContent = "⚠️ 要約エラー";
        }

        startBtn.disabled = false;
        stopBtn.disabled = true;
        stream.getTracks().forEach(track => track.stop());
      };

      mediaRecorder.start(60000); // 1分ごとにチャンクを生成
      startBtn.disabled = true;
      stopBtn.disabled = false;

      let seconds = 0;
      timerInterval = setInterval(() => {
        seconds++;
        status.textContent = `🎙️ 録音中...（${seconds} 秒経過）`;
      }, 1000);
    };

    stopBtn.onclick = () => {
      if (isStopping) return;
      isStopping = true;
      status.textContent = "🛑 録音停止中...";
      
      // 最後のデータ取得してから stop
      mediaRecorder.requestData();

      setTimeout(() => {
        mediaRecorder.stop();
      }, 300); // 少し待ってから stop
    };
  </script>
</body>
</html>
